<% layout('boilerplate') %>
<body>
  <div id="form-container">
    <div id="progress-bar-container">
      <div id="progress-bar"></div>
    </div>

    <div id="timer">Time left: <span id="time-left">10:00</span></div>

    <h3>Question <span id="question-number">1</span> of <%= allquestions.length %></h3>

    <!-- Hidden input field to store the JSON string of questions -->
    <input type="hidden" id="questions-data" value="<%- JSON.stringify(allquestions).replace(/"/g, '&quot;') %>">

    <form id="quiz-form">
      <div id="question-container">
        <!-- The first question will be rendered here by JavaScript -->
      </div>

      <div id="form-buttons">
        <button type="button" id="prev-btn" class="form-button" disabled aria-label="Previous Question">Previous</button>
        <!-- <button type="button" id="submit-btn" class="form-button" aria-label="Submit Answer">Submit</button> -->
        <button type="button" id="next-btn" class="form-button" aria-label="Next Question">Next</button>
        <button type="button" id="save-progress-btn" class="form-button" aria-label="Save Progress">Save Progress</button>
        <button type="button" id="end-exam-btn" class="form-button" aria-label="End Exam">End Exam</button>
      </div>
    </form>

    <button type="button" id="review-btn" class="form-button" style="display:none;">Review Answers</button>
  </div>

  <script>
    try {
      let jsonData = document.getElementById('questions-data').value;
      const cleanedJsonData = jsonData.replace(/&quot;/g, '"');
      const questions = JSON.parse(cleanedJsonData);

      const questionContainer = document.getElementById('question-container');
      const questionNumber = document.getElementById('question-number');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const saveProgressBtn = document.getElementById('save-progress-btn');
      const reviewBtn = document.getElementById('review-btn');
      const endExamBtn = document.getElementById('end-exam-btn');
      let currentQuestionIndex =  0;

      let selectedAnswers = {};
      let totalMarks = 0;
      let totalTime = 600; // Total time in seconds (e.g., 10 minutes)
      const timerElement = document.getElementById('time-left');

      function renderQuestion(index) {
        if (!questions || questions.length === 0) {
          questionContainer.textContent = 'No questions available.';
          return;
        }

        const question = questions[index];
        questionContainer.innerHTML = ''; // Clear previous content

        const questionText = document.createElement('p');
        questionText.classList.add('question-text');
        questionText.textContent = `Q. ${question.question} (marks ${question.marks})`;
        questionContainer.appendChild(questionText);

        for (let i = 1; i <= 4; i++) {
          const div = document.createElement('div');
          div.classList.add('form-check');

          const input = document.createElement('input');
          input.type = 'radio';
          input.classList.add('form-check-input');
          input.name = 'answer';
          input.id = `option${i}`;
          input.value = `option${i}`;

          const label = document.createElement('label');
          label.classList.add('form-check-label');
          label.setAttribute('for', `option${i}`);
          label.textContent = `${question[`option${i}`]}`;

          if (selectedAnswers[index] === `option${i}`) {
            input.checked = true;
          }

          div.appendChild(input);
          div.appendChild(label);
          questionContainer.appendChild(div);
        }

        questionNumber.textContent = index + 1;
        prevBtn.disabled = index === 0;
        nextBtn.disabled = index === questions.length - 1;

        updateProgressBar();
      }

      function saveAnswer() {
        const selectedOption = document.querySelector('input[name="answer"]:checked');
        if (selectedOption) {
          selectedAnswers[currentQuestionIndex] = selectedOption.value;
        } else {
          delete selectedAnswers[currentQuestionIndex]; // Remove answer if none is selected
        }
      }

      function updateProgressBar() {
        const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
      }

      function startTimer() {
        const timerInterval = setInterval(() => {
          const minutes = Math.floor(totalTime / 60);
          const seconds = totalTime % 60;
          timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          totalTime--;
          if (totalTime < 0) {
            clearInterval(timerInterval);
            alert("Time's up!");
            calculateTotalMarks();
            alert(`Test completed! Your total score is: ${totalMarks}`);
            showReview();
          }
        }, 1000);
      }

      function calculateTotalMarks() {
        totalMarks = 0; // Reset totalMarks to avoid duplicate addition
        questions.forEach((question, index) => {
          if (selectedAnswers[index] === question.Answer) {
            totalMarks += parseInt(question.marks);
          }
        });
      }

      function showReview() {
        document.getElementById('quiz-form').style.display = 'none';
        reviewBtn.style.display = 'block';

        const reviewContainer = document.createElement('div');
        reviewContainer.id = 'review-container';
        questions.forEach((question, index) => {
          const reviewItem = document.createElement('div');
          reviewItem.classList.add('review-item');

          reviewItem.innerHTML = `<p>Q. ${question.question} <br>`;

          for (let i = 1; i <= 4; i++) {
            const optionValue = `option${i}`;
            const isCorrect = optionValue === question.Answer;
            const isSelected = selectedAnswers[index] === optionValue;

            const optionText = question[optionValue];

            let optionHTML;
            if (isCorrect) {
              optionHTML = `<span class="correct-answer">${optionText} (Correct Answer)</span>`;
            } else if (isSelected) {
              optionHTML = `<span class="wrong-answer">${optionText} (Your Answer)</span>`;
            } else {
              optionHTML = optionText;
            }

            reviewItem.innerHTML += `${optionHTML} <br>`;
          }

          reviewItem.innerHTML += `</p>`;
          reviewContainer.appendChild(reviewItem);
        });

        document.body.appendChild(reviewContainer);
      }

      function endExam() {
        saveAnswer();
        calculateTotalMarks(); // Calculate total marks when ending the exam
        alert(`Test ended early! Your total score is: ${totalMarks}`);
        showReview();
      }

      saveProgressBtn.addEventListener('click', () => {
        localStorage.setItem('selectedAnswers', JSON.stringify(selectedAnswers));
        localStorage.setItem('currentQuestionIndex', currentQuestionIndex);
        alert('Progress saved!');
      });

      reviewBtn.addEventListener('click', showReview);

      endExamBtn.addEventListener('click', endExam);

      prevBtn.addEventListener('click', () => {
        saveAnswer();
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          renderQuestion(currentQuestionIndex);
        }
      });

      nextBtn.addEventListener('click', () => {
        saveAnswer();
        if (currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
          renderQuestion(currentQuestionIndex);
        }
      });

      renderQuestion(currentQuestionIndex);
      startTimer();

    } catch (error) {
      console.error('Error parsing JSON data:', error);
    }
  </script>

  <style>
    /* Google Forms inspired styling */

    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      color: #202124;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    #form-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
      padding: 20px;
      max-width: 600px;
      width: 100%;
    }

    #progress-bar-container {
      width: 100%;
      background-color: #e0e0e0;
      height: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    #progress-bar {
      width: 0%;
      height: 100%;
      background-color: #4285f4;
      border-radius: 4px;
      transition: width 0.5s;
    }

    #timer {
      font-size: 16px;
      font-weight: bold;
      color: #34a853;
      margin-bottom: 20px;
      text-align: right;
    }

    h3 {
      color: #202124;
      font-weight: normal;
      margin-bottom: 20px;
    }

    #question-container {
      margin-bottom: 20px;
    }

    .question-text {
      font-size: 16px;
      color: #202124;
      margin-bottom: 10px;
    }

    .form-check {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .form-check:hover {
      background-color: #f1f3f4;
    }

    .form-check-input {
      margin-right: 10px;
      transform: scale(1.2);
      cursor: pointer;
    }

    .form-check-label {
      cursor: pointer;
      color: #202124;
    }

    #form-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .form-button {
      background-color: #1a73e8;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .form-button:hover {
      background-color: #185abc;
    }

    #review-btn {
      background-color: #34a853;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 20px;
      width: 100%;
    }

    #review-container {
      margin-top: 20px;
    }

    .review-item {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f1f3f4;
      border-radius: 4px;
    }

    .correct-answer {
      color: #34a853;
      font-weight: bold;
    }

    .wrong-answer {
      color: #ea4335;
      font-weight: bold;
    }
  </style>
</body>
